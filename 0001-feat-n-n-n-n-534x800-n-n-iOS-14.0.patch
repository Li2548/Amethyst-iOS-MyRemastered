From 5df97d816405e0758ecd0eda61f606f57f3d655d Mon Sep 17 00:00:00 2001
From: herbrine8403 <herbrine8403@example.com>
Date: Mon, 20 Oct 2025 20:50:33 +0800
Subject: [PATCH 1/2] =?UTF-8?q?feat:=20=E6=B7=BB=E5=8A=A0=E8=87=AA?=
 =?UTF-8?q?=E5=AE=9A=E4=B9=89=E9=BC=A0=E6=A0=87=E6=8C=87=E9=92=88=E5=8A=9F?=
 =?UTF-8?q?=E8=83=BD\n\n-=20=E5=9C=A8=E8=AE=BE=E7=BD=AE=E7=95=8C=E9=9D=A2?=
 =?UTF-8?q?=E4=B8=AD=E6=B7=BB=E5=8A=A0=E6=9B=B4=E6=94=B9=E9=BC=A0=E6=A0=87?=
 =?UTF-8?q?=E6=8C=87=E9=92=88=E9=80=89=E9=A1=B9\n-=20=E5=AE=9E=E7=8E=B0?=
 =?UTF-8?q?=E4=BB=8E=E6=96=87=E4=BB=B6=E6=88=96=E5=9B=BE=E5=BA=93=E9=80=89?=
 =?UTF-8?q?=E6=8B=A9=E9=BC=A0=E6=A0=87=E6=8C=87=E9=92=88=E5=9B=BE=E7=89=87?=
 =?UTF-8?q?=E7=9A=84=E5=8A=9F=E8=83=BD\n-=20=E6=94=AF=E6=8C=81=E8=87=AA?=
 =?UTF-8?q?=E5=8A=A8=E7=BC=A9=E6=94=BE=E5=9B=BE=E7=89=87=E8=87=B3=E5=90=88?=
 =?UTF-8?q?=E9=80=82=E5=B0=BA=E5=AF=B8(=E6=9C=80=E5=A4=A7534x800)\n-=20?=
 =?UTF-8?q?=E5=9C=A8=E6=B8=B8=E6=88=8F=E7=95=8C=E9=9D=A2=E4=B8=AD=E5=8A=A0?=
 =?UTF-8?q?=E8=BD=BD=E5=B9=B6=E6=98=BE=E7=A4=BA=E8=87=AA=E5=AE=9A=E4=B9=89?=
 =?UTF-8?q?=E9=BC=A0=E6=A0=87=E6=8C=87=E9=92=88\n-=20=E7=A1=AE=E4=BF=9D?=
 =?UTF-8?q?=E5=85=BC=E5=AE=B9iOS=2014.0=E5=8F=8A=E4=BB=A5=E4=B8=8A?=
 =?UTF-8?q?=E7=B3=BB=E7=BB=9F?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 Natives/LauncherPreferencesViewController.m | 198 +++++++++++++++++++-
 Natives/SurfaceViewController.m             |  15 +-
 2 files changed, 211 insertions(+), 2 deletions(-)

diff --git a/Natives/LauncherPreferencesViewController.m b/Natives/LauncherPreferencesViewController.m
index e408d1e9..d4d505e4 100644
--- a/Natives/LauncherPreferencesViewController.m
+++ b/Natives/LauncherPreferencesViewController.m
@@ -1,4 +1,6 @@
 #import <Foundation/Foundation.h>
+#import <UniformTypeIdentifiers/UniformTypeIdentifiers.h>
+#import <Photos/Photos.h>
 
 #import "DBNumberedSlider.h"
 #import "HostManagerBridge.h"
@@ -17,8 +19,9 @@
 #import "ImageCropperViewController.h"
 #import "CustomIconManager.h"
 
-@interface LauncherPreferencesViewController()
+@interface LauncherPreferencesViewController() <UIDocumentPickerDelegate>
 @property(nonatomic) NSArray<NSString*> *rendererKeys, *rendererList;
+@property(nonatomic) UIImage *selectedMousePointerImage;
 @end
 
 @implementation LauncherPreferencesViewController
@@ -156,6 +159,191 @@
     [self presentViewController:alert animated:YES completion:nil];
 }
 
+- (void)showMousePointerSelectionAlert {
+    UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"更改鼠标指针" message:@"请选择如何选择鼠标指针图片" preferredStyle:UIAlertControllerStyleAlert];
+    
+    UIAlertAction *fileAction = [UIAlertAction actionWithTitle:@"从文件中选择" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
+        [self selectMousePointerFromFile];
+    }];
+    
+    UIAlertAction *photoAction = [UIAlertAction actionWithTitle:@"从图库中选择" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
+        [self selectMousePointerFromPhoto];
+    }];
+    
+    UIAlertAction *cancelAction = [UIAlertAction actionWithTitle:@"取消" style:UIAlertActionStyleCancel handler:nil];
+    
+    [alert addAction:fileAction];
+    [alert addAction:photoAction];
+    [alert addAction:cancelAction];
+    
+    [self presentViewController:alert animated:YES completion:nil];
+}
+
+- (void)selectMousePointerFromFile {
+    if (@available(iOS 14.0, *)) {
+        UIDocumentPickerViewController *documentPicker = [[UIDocumentPickerViewController alloc] initWithForOpeningContentTypes:@[
+            UTTypePNG,
+            UTTypeJPEG,
+            UTTypeTIFF,
+            UTTypeBMP,
+            UTTypeGIF
+        ] allowMultipleSelection:NO];
+        documentPicker.delegate = self;
+        [self presentViewController:documentPicker animated:YES completion:nil];
+    } else {
+        UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"不支持" message:@"文件选择功能需要iOS 14.0或更高版本" preferredStyle:UIAlertControllerStyleAlert];
+        UIAlertAction *okAction = [UIAlertAction actionWithTitle:@"确定" style:UIAlertActionStyleDefault handler:nil];
+        [alert addAction:okAction];
+        [self presentViewController:alert animated:YES completion:nil];
+    }
+}
+
+- (void)selectMousePointerFromPhoto {
+    // 检查照片库访问权限
+    [PHPhotoLibrary requestAuthorization:^(PHAuthorizationStatus status) {
+        dispatch_async(dispatch_get_main_queue(), ^{
+            if (status == PHAuthorizationStatusAuthorized) {
+                // 权限已授权
+                UIImagePickerController *imagePicker = [[UIImagePickerController alloc] init];
+                imagePicker.sourceType = UIImagePickerControllerSourceTypePhotoLibrary;
+                imagePicker.delegate = self;
+                imagePicker.mediaTypes = @[(NSString *)kUTTypeImage]; // 只显示图片
+                [self presentViewController:imagePicker animated:YES completion:nil];
+            } else {
+                // 权限未授权
+                UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"访问受限" message:@"请前往设置开启对照片库的访问权限" preferredStyle:UIAlertControllerStyleAlert];
+                UIAlertAction *settingsAction = [UIAlertAction actionWithTitle:@"前往设置" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
+                    [[UIApplication sharedApplication] openURL:[NSURL URLWithString:UIApplicationOpenSettingsURLString] options:@{} completionHandler:nil];
+                }];
+                UIAlertAction *cancelAction = [UIAlertAction actionWithTitle:@"取消" style:UIAlertActionStyleCancel handler:nil];
+                [alert addAction:settingsAction];
+                [alert addAction:cancelAction];
+                [self presentViewController:alert animated:YES completion:nil];
+            }
+        });
+    }];
+}
+
+#pragma mark - UIDocumentPickerDelegate
+
+- (void)documentPicker:(UIDocumentPickerViewController *)controller didFinishPickingDocumentsWithURLs:(NSArray<NSURL *> *)urls {
+    if (urls.count > 0) {
+        NSURL *selectedFileURL = urls[0];
+        [self processSelectedImageAtURL:selectedFileURL];
+    }
+}
+
+- (void)documentPickerWasCancelled:(UIDocumentPickerViewController *)controller {
+    // 用户取消选择
+    [self showCustomIconError:@"文件选择已取消"];
+}
+
+#pragma mark - UIImagePickerControllerDelegate
+
+- (void)imagePickerController:(UIImagePickerController *)picker didFinishPickingMediaWithInfo:(NSDictionary<UIImagePickerControllerInfoKey,id> *)info {
+    [picker dismissViewControllerAnimated:YES completion:^{
+        UIImage *selectedImage = info[UIImagePickerControllerOriginalImage];
+        if (!selectedImage) {
+            [self showCustomIconError:@"无法获取选中的图片"];
+            return;
+        }
+        
+        // 在后台线程处理图片
+        dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
+            // 创建临时文件URL
+            NSURL *tempURL = [self createTemporaryImageURL:selectedImage];
+            if (tempURL) {
+                dispatch_async(dispatch_get_main_queue(), ^{
+                    [self processSelectedImageAtURL:tempURL];
+                });
+            } else {
+                dispatch_async(dispatch_get_main_queue(), ^{
+                    [self showCustomIconError:@"创建临时文件失败"];
+                });
+            }
+        });
+    }];
+}
+
+- (void)imagePickerControllerDidCancel:(UIImagePickerController *)picker {
+    [picker dismissViewControllerAnimated:YES completion:^{
+        dispatch_async(dispatch_get_main_queue(), ^{
+            [self showCustomIconError:@"图片选择已取消"];
+        });
+    }];
+}
+
+- (NSURL *)createTemporaryImageURL:(UIImage *)image {
+    // 创建临时目录
+    NSURL *tempDirectory = [NSURL fileURLWithPath:NSTemporaryDirectory()];
+    NSString *fileName = [NSString stringWithFormat:@"mouse_pointer_temp_%@.png", [[NSUUID UUID] UUIDString]];
+    NSURL *tempFileURL = [tempDirectory URLByAppendingPathComponent:fileName];
+    
+    // 将图片保存为PNG格式
+    NSData *imageData = UIImagePNGRepresentation(image);
+    if ([imageData writeToFile:tempFileURL.path atomically:YES]) {
+        return tempFileURL;
+    }
+    
+    return nil;
+}
+
+- (void)processSelectedImageAtURL:(NSURL *)fileURL {
+    // 在后台线程处理图片
+    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
+        // 读取图片
+        UIImage *originalImage = [UIImage imageWithContentsOfFile:fileURL.path];
+        if (!originalImage) {
+            dispatch_async(dispatch_get_main_queue(), ^{
+                [self showCustomIconError:@"无法读取选中的图片文件"];
+            });
+            return;
+        }
+        
+        // 检查图片尺寸是否合适
+        CGSize imageSize = originalImage.size;
+        if (imageSize.width > 534 || imageSize.height > 800) {
+            // 如果图片太大，进行缩放
+            float scale = MIN(MIN(534.0f / imageSize.width, 800.0f / imageSize.height), 1.0f);
+            CGSize newSize = CGSizeMake(imageSize.width * scale, imageSize.height * scale);
+            
+            UIGraphicsBeginImageContextWithOptions(newSize, NO, 0.0);
+            [originalImage drawInRect:CGRectMake(0, 0, newSize.width, newSize.height)];
+            UIImage *scaledImage = UIGraphicsGetImageFromCurrentImageContext();
+            UIGraphicsEndImageContext();
+            
+            originalImage = scaledImage;
+        }
+        
+        // 保存图片到应用文档目录
+        NSURL *documentsDirectory = [NSURL fileURLWithPath:[NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) firstObject]];
+        NSString *destinationPath = [documentsDirectory.path stringByAppendingPathComponent:@"custom_mouse_pointer.png"];
+        
+        NSData *imageData = UIImagePNGRepresentation(originalImage);
+        if ([imageData writeToFile:destinationPath atomically:YES]) {
+            // 设置为选中的鼠标指针图片
+            self.selectedMousePointerImage = originalImage;
+            
+            // 通知用户操作成功
+            dispatch_async(dispatch_get_main_queue(), ^{
+                [self showSuccessMessage:@"鼠标指针已更新"];
+                
+                // 保存到偏好设置中，以便在SurfaceViewController中使用
+                setPrefObject(@"control.custom_mouse_pointer_path", destinationPath);
+            });
+        } else {
+            dispatch_async(dispatch_get_main_queue(), ^{
+                [self showCustomIconError:@"保存鼠标指针图片失败"];
+            });
+        }
+        
+        // 删除临时文件（如果需要）
+        if ([[fileURL.path componentsSeparatedByString:@"/"] containsObject:@"mouse_pointer_temp_"]) {
+            [[NSFileManager defaultManager] removeItemAtURL:fileURL error:nil];
+        }
+    });
+}
+
 - (void)viewDidLoad
 {
     self.getPreference = ^id(NSString *section, NSString *key){
@@ -456,6 +644,14 @@
                 @"icon": @"cursorarrow.rays",
                 @"type": self.typeSwitch
             },
+            @{@"key": @"change_mouse_pointer",
+                @"hasDetail": @YES,
+                @"icon": @"cursorarrow",
+                @"type": self.typeButton,
+                @"action": ^void(){
+                    [self showMousePointerSelectionAlert];
+                }
+            },
             @{@"key": @"gyroscope_enable",
                 @"hasDetail": @YES,
                 @"icon": @"gyroscope",
diff --git a/Natives/SurfaceViewController.m b/Natives/SurfaceViewController.m
index 8923dae7..1ce65e1c 100644
--- a/Natives/SurfaceViewController.m
+++ b/Natives/SurfaceViewController.m
@@ -181,7 +181,20 @@ static GameSurfaceView* pojavWindow;
     self.mousePointerView = [[UIImageView alloc] initWithFrame:virtualMouseFrame];
     self.mousePointerView.autoresizingMask = UIViewAutoresizingFlexibleLeftMargin | UIViewAutoresizingFlexibleTopMargin | UIViewAutoresizingFlexibleRightMargin |UIViewAutoresizingFlexibleBottomMargin;
     self.mousePointerView.hidden = !virtualMouseEnabled;
-    self.mousePointerView.image = [UIImage imageNamed:@"MousePointer"];
+    
+    // Check if custom mouse pointer exists
+    NSString *customMousePointerPath = getPrefObject(@"control.custom_mouse_pointer_path");
+    if (customMousePointerPath && [[NSFileManager defaultManager] fileExistsAtPath:customMousePointerPath]) {
+        UIImage *customMousePointerImage = [UIImage imageWithContentsOfFile:customMousePointerPath];
+        if (customMousePointerImage) {
+            self.mousePointerView.image = customMousePointerImage;
+        } else {
+            self.mousePointerView.image = [UIImage imageNamed:@"MousePointer"];
+        }
+    } else {
+        self.mousePointerView.image = [UIImage imageNamed:@"MousePointer"];
+    }
+    
     self.mousePointerView.userInteractionEnabled = NO;
     [self.touchView addSubview:self.mousePointerView];
 
-- 
2.51.1

