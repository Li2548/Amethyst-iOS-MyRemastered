name: Upload .tipa to FTP

on:
  workflow_dispatch:
    inputs:
      workflow_run_number:
        description: 'Workflow run number to download from (e.g. 19702930669)'
        required: true
        type: string

jobs:
  upload-tipa:
    runs-on: ubuntu-latest
    steps:
      - name: Get specified workflow run
        id: specified_run
        run: |
          # Get the specified workflow run by run number
          RUN_ID=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=100" | \
            jq -r --arg RUN_NUMBER "${{ inputs.workflow_run_number }}" \
            '.workflow_runs[] | select(.run_number == ($RUN_NUMBER | tonumber)) | .id' | head -n 1)
          
          if [ -z "$RUN_ID" ]; then
            echo "No workflow run found with number ${{ inputs.workflow_run_number }}"
            exit 1
          fi
          
          echo "Found run ID: $RUN_ID"
          echo "target_run_id=$RUN_ID" >> $GITHUB_ENV

      - name: Get workflow run artifacts
        id: get_artifacts
        run: |
          # Get artifacts from the specified run
          curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ env.target_run_id }}/artifacts" | \
            jq -r '.artifacts[] | select(.name | test("\\.tipa$")) | .id' > tipa_ids.txt
          
          # Get the first .tipa artifact ID
          TIPA_ID=$(head -n 1 tipa_ids.txt)
          if [ -z "$TIPA_ID" ]; then
            echo "No .tipa artifact found in run ${{ env.target_run_id }}"
            exit 1
          fi
          
          echo "tipa_artifact_id=$TIPA_ID" >> $GITHUB_ENV
          
      - name: Download artifact
        run: |
          # Download the .tipa artifact
          curl -s -L -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -o artifact.zip \
            "https://api.github.com/repos/${{ github.repository }}/actions/artifacts/${{ env.tipa_artifact_id }}/zip"
          
          # Extract the .tipa file
          unzip artifact.zip
          
          # Find the .tipa file
          TIPA_FILE=$(find . -name "*.tipa" -type f | head -n 1)
          if [ -z "$TIPA_FILE" ]; then
            echo "No .tipa file found in the downloaded artifact"
            exit 1
          fi
          
          echo "tipa_file=$TIPA_FILE" >> $GITHUB_ENV
          echo "Found .tipa file: $TIPA_FILE"

      - name: Upload to FTP
        run: |
          # Install lftp
          sudo apt-get update
          sudo apt-get install -y lftp
          
          # Check if the .tipa file exists and get its exact name
          echo "Checking for .tipa file..."
          TIPA_FILE=$(find . -name "*.tipa" -type f | head -n 1)
          echo "Found .tipa file: $TIPA_FILE"
          
          if [ -z "$TIPA_FILE" ]; then
            echo "Error: No .tipa file found!"
            exit 1
          fi
          
          # Get the original filename
          ORIGINAL_FILENAME=$(basename "$TIPA_FILE")
          echo "Original filename: $ORIGINAL_FILENAME"
          
          # Upload the .tipa file to FTP server with its original filename
          echo "Uploading $TIPA_FILE to FTP with original name: $ORIGINAL_FILENAME"
          lftp -c "set ftp:ssl-protect-data true; 
                   open ftp://${FTP_USERNAME}:${FTP_PASSWORD}@ftpupload.net; 
                   cd /htdocs/file; 
                   put '$TIPA_FILE' -o '$ORIGINAL_FILENAME'; 
                   echo 'File upload completed';
                   ls -la /htdocs/file; 
                   bye" 
        env:
          FTP_USERNAME: if0_39971160
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}